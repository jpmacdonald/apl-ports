# APL Ports - Update Index
#
# Two-phase CI pipeline:
# 1. Discovery: check if any ports need building, per-arch
# 2. Build: one job per architecture, builder handles layer ordering internally

name: Update Ports Index

on:
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM UTC
  workflow_dispatch:
    inputs:
      filter:
        description: 'Filter to specific port (optional)'
        required: false
        type: string
      max_versions:
        description: 'Max versions per port'
        required: false
        default: '2'
        type: string

jobs:
  # Phase 1: Discovery
  # Check what needs building per-arch to avoid spinning up unnecessary runners
  discover:
    runs-on: macos-14
    outputs:
      has_arm64_tasks: ${{ steps.discover.outputs.has_arm64_tasks }}
      has_x86_64_tasks: ${{ steps.discover.outputs.has_x86_64_tasks }}
    steps:
      - name: Checkout Ports
        uses: actions/checkout@v4

      - name: Checkout apl
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/apl
          path: apl

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust Cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: apl -> target

      - name: Build apl-builder
        working-directory: apl
        run: cargo build --release -p apl-builder

      - name: Discover build tasks
        id: discover
        env:
          APL_ARTIFACT_STORE_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          APL_ARTIFACT_STORE_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY }}
          APL_ARTIFACT_STORE_SECRET_KEY: ${{ secrets.R2_SECRET_KEY }}
          APL_ARTIFACT_STORE_BUCKET: ${{ secrets.R2_BUCKET }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          FILTER_ARG=""
          if [ -n "${{ inputs.filter }}" ]; then
            FILTER_ARG="--filter ${{ inputs.filter }}"
          fi

          MAX_VERSIONS="${{ inputs.max_versions }}"
          MAX_VERSIONS="${MAX_VERSIONS:-2}"

          ./apl/target/release/apl-builder \
            --ports-dir . \
            --discover \
            --max-versions "$MAX_VERSIONS" \
            $FILTER_ARG > discovery.json 2>discovery.log

          cat discovery.log

          if ! jq -e '.tasks' discovery.json > /dev/null 2>&1; then
            echo "::error::Discovery failed - invalid JSON output"
            cat discovery.json >&2
            exit 1
          fi

          # Check tasks per arch
          ARM64_COUNT=$(jq '[.tasks[] | select(.arch == "arm64")] | length' discovery.json)
          X86_64_COUNT=$(jq '[.tasks[] | select(.arch == "x86_64")] | length' discovery.json)

          echo "Found $ARM64_COUNT arm64 tasks, $X86_64_COUNT x86_64 tasks"

          if [ "$ARM64_COUNT" -gt 0 ]; then
            echo "has_arm64_tasks=true" >> $GITHUB_OUTPUT
          else
            echo "has_arm64_tasks=false" >> $GITHUB_OUTPUT
          fi

          if [ "$X86_64_COUNT" -gt 0 ]; then
            echo "has_x86_64_tasks=true" >> $GITHUB_OUTPUT
          else
            echo "has_x86_64_tasks=false" >> $GITHUB_OUTPUT
          fi

  # Phase 2: Build
  # Single job per architecture - builder handles dependency ordering internally
  build-arm64:
    needs: discover
    if: needs.discover.outputs.has_arm64_tasks == 'true'
    runs-on: macos-14
    steps:
      - name: Checkout Ports
        uses: actions/checkout@v4

      - name: Checkout apl
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/apl
          path: apl

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust Cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: apl -> target

      - name: Build apl-builder
        working-directory: apl
        run: cargo build --release -p apl-builder

      - name: Build ports (arm64)
        env:
          APL_ARTIFACT_STORE_ENABLED: "true"
          APL_ARTIFACT_STORE_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          APL_ARTIFACT_STORE_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY }}
          APL_ARTIFACT_STORE_SECRET_KEY: ${{ secrets.R2_SECRET_KEY }}
          APL_ARTIFACT_STORE_BUCKET: ${{ secrets.R2_BUCKET }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          FILTER_ARG=""
          if [ -n "${{ inputs.filter }}" ]; then
            FILTER_ARG="--filter ${{ inputs.filter }}"
          fi

          MAX_VERSIONS="${{ inputs.max_versions }}"
          MAX_VERSIONS="${MAX_VERSIONS:-2}"

          ./apl/target/release/apl-builder \
            --ports-dir . \
            --output-dir output \
            --arch arm64 \
            --max-versions "$MAX_VERSIONS" \
            $FILTER_ARG

      - name: Upload Build Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-arm64
          path: ~/.apl/logs/
          if-no-files-found: ignore

  build-x86_64:
    needs: discover
    if: needs.discover.outputs.has_x86_64_tasks == 'true'
    runs-on: macos-15-intel
    steps:
      - name: Checkout Ports
        uses: actions/checkout@v4

      - name: Checkout apl
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/apl
          path: apl

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust Cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: apl -> target

      - name: Build apl-builder
        working-directory: apl
        run: cargo build --release -p apl-builder

      - name: Build ports (x86_64)
        env:
          APL_ARTIFACT_STORE_ENABLED: "true"
          APL_ARTIFACT_STORE_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          APL_ARTIFACT_STORE_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY }}
          APL_ARTIFACT_STORE_SECRET_KEY: ${{ secrets.R2_SECRET_KEY }}
          APL_ARTIFACT_STORE_BUCKET: ${{ secrets.R2_BUCKET }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          FILTER_ARG=""
          if [ -n "${{ inputs.filter }}" ]; then
            FILTER_ARG="--filter ${{ inputs.filter }}"
          fi

          MAX_VERSIONS="${{ inputs.max_versions }}"
          MAX_VERSIONS="${MAX_VERSIONS:-2}"

          ./apl/target/release/apl-builder \
            --ports-dir . \
            --output-dir output \
            --arch x86_64 \
            --max-versions "$MAX_VERSIONS" \
            $FILTER_ARG

      - name: Upload Build Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-x86_64
          path: ~/.apl/logs/
          if-no-files-found: ignore

  # Phase 3: Notify
  notify:
    needs: [discover, build-arm64, build-x86_64]
    if: always() && (needs.discover.outputs.has_arm64_tasks == 'true' || needs.discover.outputs.has_x86_64_tasks == 'true')
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Index Rebuild
        if: needs.build-arm64.result != 'failure' && needs.build-x86_64.result != 'failure'
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.PAT_TOKEN }}
          repository: ${{ github.repository_owner }}/apl-packages
          event-type: ports-updated

      - name: Report Status
        run: |
          echo "arm64 build: ${{ needs.build-arm64.result }}"
          echo "x86_64 build: ${{ needs.build-x86_64.result }}"
          if [ "${{ needs.build-arm64.result }}" == "failure" ] || [ "${{ needs.build-x86_64.result }}" == "failure" ]; then
            echo "Some builds failed, check job logs"
            exit 1
          fi
